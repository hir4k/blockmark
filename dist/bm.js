var BlockMark=function(){"use strict";class e{constructor(){this.blocks=[]}addBlock(e,t={},n=null){const s=null!=n?n+1:this.blocks.length;this.blocks.splice(s,0,{type:e,data:t})}removeBlock(e){this.blocks.length<=1||this.blocks.splice(e,1)}getBlocks(){return this.blocks}getBlock(e){return this.blocks[e]||null}getBlockCount(){return this.blocks.length}save(){return this.blocks.map(({type:e,data:t})=>({type:e,...t}))}load(e){this.blocks=[],e.forEach(e=>{const{type:t,...n}=e;this.addBlock(t,n)})}}class t{static type="paragraph";static name="Paragraph";static icon='<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><rect x="3" y="4" width="14" height="2" rx="1" fill="#ffffff"/><rect x="3" y="8" width="10" height="2" rx="1" fill="#ffffff"/><rect x="3" y="12" width="7" height="2" rx="1" fill="#ffffff"/></svg>';static defaultData={text:[]};constructor({data:e={},onEnter:t,onBackspace:n}){this.data=e.text||[],this.onEnter=t,this.onBackspace=n,this.element=document.createElement("div"),this.element.contentEditable=!0,this.element.className="paragraph-block",this.element.setAttribute("data-block-type","paragraph"),this.pendingSplitData=null,this.pendingMergeData=null}render(){return this.element.innerHTML=this._renderText(),this.element.addEventListener("input",()=>{this._updateData()}),this.element.addEventListener("keydown",e=>{if("Enter"===e.key&&(e.preventDefault(),this._handleEnterKey()),"Backspace"===e.key){if(""===this.element.textContent.trim())e.preventDefault(),this.onBackspace?.();else{const t=window.getSelection();if(t.rangeCount>0){const n=t.getRangeAt(0);0===this._getCaretOffset(n)&&(e.preventDefault(),this._handleBackspaceAtBeginning())}}}}),this.element.addEventListener("paste",e=>{e.preventDefault();let t=e.clipboardData.getData("text/plain");t=t.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ").replace(/\t/g," "),t=t.replace(/[ ]+/g," "),document.execCommand("insertText",!1,t)}),this._updateData(),this.element}_handleEnterKey(){const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),n=this.element.textContent,s=this._getCaretOffset(t);s>=n.length?this.onEnter?.():this._splitParagraphAtCaret(t,s)}_getCaretOffset(e){let t=0;const n=document.createTreeWalker(this.element,NodeFilter.SHOW_TEXT,null,!1);let s;for(;s=n.nextNode();){if(s===e.startContainer){t+=e.startOffset;break}t+=s.textContent.length}return t}_splitParagraphAtCaret(e,t){const n=this.element.textContent,s=n.substring(0,t),i=n.substring(t);this.element.textContent=s,this._updateData(),i.trim()&&(this.pendingSplitData={text:[{text:i}]}),this.onEnter?.()}_handleBackspaceAtBeginning(){const e=this.element.textContent;e.trim()&&(this.pendingMergeData={text:[{text:e}]}),this.onBackspace?.()}getPendingSplitData(){const e=this.pendingSplitData;return this.pendingSplitData=null,e}getPendingMergeData(){const e=this.pendingMergeData;return this.pendingMergeData=null,e}_renderText(){return 0===this.data.length?"<br>":this.data.map(e=>{let t=e.text||"";return e.bold&&(t=`<strong>${t}</strong>`),e.italic&&(t=`<em>${t}</em>`),e.underline&&(t=`<u>${t}</u>`),t}).join("")}_updateData(){const e=this._parseHtmlContent(this.element.innerHTML);this.data=e.map(e=>{if(e.text){let t=e.text;return t=t.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ").replace(/\t/g," "),t=t.replace(/[ ]+/g," "),{...e,text:t}}return e}).filter(e=>""!==e.text),0===this.data.length&&(this.data=[{text:""}])}_parseHtmlContent(e){if(!e||"<br>"===e)return[{text:""}];const t=[],n=document.createElement("div");return n.innerHTML=e,this._processNode(n,t),t.length>0?t:[{text:""}]}_processNode(e,t){if(e.nodeType===Node.TEXT_NODE){const n=e.textContent;n.trim()&&t.push({text:n})}else if(e.nodeType===Node.ELEMENT_NODE){const n=e.tagName.toLowerCase(),s=Array.from(e.childNodes);if(0===s.length)return;const i={};if("strong"!==n&&"b"!==n||(i.bold=!0),"em"!==n&&"i"!==n||(i.italic=!0),"u"===n&&(i.underline=!0),Object.keys(i).length>0){const e=[];s.forEach(t=>this._processNode(t,e)),e.forEach(e=>{t.push({...e,...i})})}else s.forEach(e=>this._processNode(e,t))}}save(){const e=this.data.map(e=>{if(e.text){let t=e.text;return t=t.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ").replace(/\t/g," "),t=t.replace(/[ ]+/g," "),{...e,text:t}}return e}).filter(e=>""!==e.text);return{type:"paragraph",text:e.length>0?e:[{text:""}]}}}class n{static type="list";static name="List";static icon='<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><circle cx="6" cy="10" r="2" fill="#ffffff"/><rect x="10" y="9" width="7" height="2" rx="1" fill="#ffffff"/></svg>';static defaultData={ordered:!1,items:[]};static getUnorderedList(){return{type:"list",name:"Bullet List",icon:'<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><circle cx="6" cy="10" r="2" fill="#ffffff"/><rect x="10" y="9" width="7" height="2" rx="1" fill="#ffffff"/></svg>',defaultData:{ordered:!1,items:[]}}}static getOrderedList(){return{type:"list",name:"Numbered List",icon:'<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><text x="4" y="12" font-size="8" fill="#ffffff">1.</text><rect x="10" y="9" width="7" height="2" rx="1" fill="#ffffff"/></svg>',defaultData:{ordered:!0,items:[]}}}constructor({data:e={},onBackspace:t}){this.data={ordered:e.ordered||!1,items:e.items||[]},this.onBackspace=t,this.element=document.createElement(this.data.ordered?"ol":"ul"),this.element.className="list-block",this.element.setAttribute("data-block-type","list"),this.element.contentEditable=!1}render(){return this.element.innerHTML="",this.data.items.forEach((e,t)=>{const n=this._createItem(e,t);this.element.appendChild(n)}),0===this.element.children.length&&this.element.appendChild(this._createItem([],0)),this.element}_createItem(e=[],t){const n=document.createElement("li");return n.contentEditable=!0,n.setAttribute("data-item-index",t),n.innerHTML=this._renderTextSegments(e),n.addEventListener("input",()=>{this._updateItemData(t,n)}),n.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const s=t+1,i=this._createItem([],s);this.element.insertBefore(i,n.nextSibling),this._updateIndices(),setTimeout(()=>i.focus(),0)}if("Backspace"===e.key&&""===n.textContent.trim())if(1===this.element.children.length)e.preventDefault(),this.onBackspace?.();else{const t=n.previousSibling;if(n.remove(),this._updateIndices(),t?.focus){t.focus();const e=document.createRange(),n=window.getSelection();e.selectNodeContents(t),e.collapse(!1),n.removeAllRanges(),n.addRange(e)}e.preventDefault()}}),n.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain").replace(/\r?\n/g," ").replace(/\s+/g," ").trim();document.execCommand("insertText",!1,t)}),n}_renderTextSegments(e){return 0===e.length?"<br>":e.map(e=>{let t=e.text||"";return e.bold&&(t=`<strong>${t}</strong>`),e.italic&&(t=`<em>${t}</em>`),e.underline&&(t=`<u>${t}</u>`),t}).join("")}_updateItemData(e,t){const n=this._parseHtmlContent(t.innerHTML);this.data.items[e]=n}_parseHtmlContent(e){if(!e||"<br>"===e)return[{text:""}];const t=[],n=document.createElement("div");return n.innerHTML=e,this._processNode(n,t),t.length>0?t:[{text:""}]}_processNode(e,t){if(e.nodeType===Node.TEXT_NODE){const n=e.textContent;n.trim()&&t.push({text:n})}else if(e.nodeType===Node.ELEMENT_NODE){const n=e.tagName.toLowerCase(),s=Array.from(e.childNodes);if(0===s.length)return;const i={};if("strong"!==n&&"b"!==n||(i.bold=!0),"em"!==n&&"i"!==n||(i.italic=!0),"u"===n&&(i.underline=!0),Object.keys(i).length>0){const e=[];s.forEach(t=>this._processNode(t,e)),e.forEach(e=>{t.push({...e,...i})})}else s.forEach(e=>this._processNode(e,t))}}_updateIndices(){this.element.querySelectorAll("li").forEach((e,t)=>{e.setAttribute("data-item-index",t)})}_updateAllItemsData(){const e=this.element.querySelectorAll("li");e.length!==this.data.items.length?(this.data.items=[],e.forEach((e,t)=>{const n=this._parseHtmlContent(e.innerHTML);this.data.items[t]=n})):e.forEach((e,t)=>{const n=this._parseHtmlContent(e.innerHTML);this.data.items[t]=n})}save(){const e=[];return this.element.querySelectorAll("li").forEach(t=>{const n=this._parseHtmlContent(t.innerHTML);e.push(n)}),{type:"list",ordered:this.data.ordered,items:e}}}class s{static type="table";static name="Table";static icon='<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><rect x="3" y="3" width="14" height="14" rx="1" stroke="#ffffff" stroke-width="1.5"/><line x1="7" y1="3" x2="7" y2="17" stroke="#ffffff" stroke-width="1.5"/><line x1="13" y1="3" x2="13" y2="17" stroke="#ffffff" stroke-width="1.5"/><line x1="3" y1="7" x2="17" y2="7" stroke="#ffffff" stroke-width="1.5"/><line x1="3" y1="11" x2="17" y2="11" stroke="#ffffff" stroke-width="1.5"/></svg>';static defaultData={rows:2,columns:2,cells:[]};constructor({data:e={},onBackspace:t}){this.data={rows:e.rows||3,columns:e.columns||3,cells:e.cells||[]},this.onBackspace=t,this.element=document.createElement("div"),this.element.className="table-block",this.element.setAttribute("data-block-type","table"),this.element.contentEditable=!1}render(){this.element.innerHTML="";const e=document.createElement("div");e.style.cssText="\n            border: 1px solid #e2e8f0;\n            border-radius: 6px;\n            overflow: hidden;\n            margin: 8px 0;\n        ";const t=document.createElement("table");t.style.cssText="\n            width: 100%;\n            border-collapse: collapse;\n            background: white;\n        ";const n=document.createElement("tbody");0===this.data.cells.length&&this._initializeCells();for(let e=0;e<this.data.rows;e++){const t=document.createElement("tr");for(let n=0;n<this.data.columns;n++){const s=e*this.data.columns+n,i=this.data.cells[s]||{text:[]},o=this._createCell(i,e,n);t.appendChild(o)}n.appendChild(t)}t.appendChild(n),e.appendChild(t);const s=this._createTableControls();return e.appendChild(s),this.element.appendChild(e),this.element}_initializeCells(){this.data.cells=[];for(let e=0;e<this.data.rows*this.data.columns;e++)this.data.cells.push({text:[]})}_createCell(e,t,n){const s=document.createElement("td");return s.contentEditable=!0,s.setAttribute("data-row",t),s.setAttribute("data-col",n),s.style.cssText="\n            border: 1px solid #e2e8f0;\n            padding: 8px 12px;\n            min-width: 80px;\n            min-height: 40px;\n            vertical-align: top;\n        ",s.innerHTML=this._renderTextSegments(e.text||[]),s.addEventListener("input",()=>{this._updateCellData(t,n,s)}),s.addEventListener("keydown",e=>{"Tab"===e.key&&(e.preventDefault(),this._navigateToNextCell(t,n,e.shiftKey))}),s.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain").replace(/\r?\n/g," ").replace(/\s+/g," ").trim();document.execCommand("insertText",!1,t)}),s}_renderTextSegments(e){return 0===e.length?"<br>":e.map(e=>{let t=e.text||"";return e.bold&&(t=`<strong>${t}</strong>`),e.italic&&(t=`<em>${t}</em>`),e.underline&&(t=`<u>${t}</u>`),t}).join("")}_updateCellData(e,t,n){const s=e*this.data.columns+t,i=this._parseHtmlContent(n.innerHTML);this.data.cells[s]={text:i}}_parseHtmlContent(e){if(!e||"<br>"===e)return[{text:""}];const t=[],n=document.createElement("div");return n.innerHTML=e,this._processNode(n,t),t.length>0?t:[{text:""}]}_processNode(e,t){if(e.nodeType===Node.TEXT_NODE){const n=e.textContent;n.trim()&&t.push({text:n})}else if(e.nodeType===Node.ELEMENT_NODE){const n=e.tagName.toLowerCase(),s=Array.from(e.childNodes);if(0===s.length)return;const i={};if("strong"!==n&&"b"!==n||(i.bold=!0),"em"!==n&&"i"!==n||(i.italic=!0),"u"===n&&(i.underline=!0),Object.keys(i).length>0){const e=[];s.forEach(t=>this._processNode(t,e)),e.forEach(e=>{t.push({...e,...i})})}else s.forEach(e=>this._processNode(e,t))}}_navigateToNextCell(e,t,n=!1){const s=this.element.querySelectorAll('td[contenteditable="true"]');let i=-1;if(n)for(let n=s.length-1;n>=0;n--){const o=s[n],a=parseInt(o.getAttribute("data-row")),r=parseInt(o.getAttribute("data-col"));if(a===e&&r<t||a<e){i=n;break}}else for(let n=0;n<s.length;n++){const o=s[n],a=parseInt(o.getAttribute("data-row")),r=parseInt(o.getAttribute("data-col"));if(a===e&&r>t||a>e){i=n;break}}i>=0&&s[i].focus()}_createTableControls(){const e=document.createElement("div");e.style.cssText="\n            display: flex;\n            gap: 8px;\n            padding: 8px;\n            background: #f8fafc;\n            border-top: 1px solid #e2e8f0;\n        ";const t=document.createElement("button");t.textContent="+ Row",t.style.cssText="\n            padding: 4px 8px;\n            border: 1px solid #cbd5e1;\n            border-radius: 4px;\n            background: white;\n            cursor: pointer;\n            font-size: 12px;\n        ",t.addEventListener("click",()=>this._addRow());const n=document.createElement("button");n.textContent="+ Column",n.style.cssText="\n            padding: 4px 8px;\n            border: 1px solid #cbd5e1;\n            border-radius: 4px;\n            background: white;\n            cursor: pointer;\n            font-size: 12px;\n        ",n.addEventListener("click",()=>this._addColumn());const s=document.createElement("button");s.textContent="- Row",s.style.cssText="\n            padding: 4px 8px;\n            border: 1px solid #cbd5e1;\n            border-radius: 4px;\n            background: white;\n            cursor: pointer;\n            font-size: 12px;\n        ",s.addEventListener("click",()=>this._removeRow());const i=document.createElement("button");return i.textContent="- Column",i.style.cssText="\n            padding: 4px 8px;\n            border: 1px solid #cbd5e1;\n            border-radius: 4px;\n            background: white;\n            cursor: pointer;\n            font-size: 12px;\n        ",i.addEventListener("click",()=>this._removeColumn()),e.appendChild(t),e.appendChild(n),e.appendChild(s),e.appendChild(i),e}_addRow(){this.data.rows++;for(let e=0;e<this.data.columns;e++)this.data.cells.push({text:[]});this.render()}_addColumn(){this.data.columns++;for(let e=0;e<this.data.rows;e++){const t=(e+1)*this.data.columns-1;this.data.cells.splice(t,0,{text:[]})}this.render()}_removeRow(){if(this.data.rows<=1)return;this.data.rows--;const e=this.data.columns;this.data.cells.splice(-e),this.render()}_removeColumn(){if(this.data.columns<=1)return;this.data.columns--;const e=[];for(let t=0;t<this.data.rows;t++){const n=t*(this.data.columns+1),s=n+this.data.columns;e.push(...this.data.cells.slice(n,s))}this.data.cells=e,this.render()}save(){const e=[];return this.element.querySelectorAll('td[contenteditable="true"]').forEach(t=>{const n=parseInt(t.getAttribute("data-row")),s=parseInt(t.getAttribute("data-col")),i=this._parseHtmlContent(t.innerHTML),o=n*this.data.columns+s;e[o]={text:i}}),{type:"table",rows:this.data.rows,columns:this.data.columns,cells:e}}}class i{static type="youtube";static name="YouTube Video";static icon='<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" fill="#ffffff"/></svg>';static defaultData={url:""};constructor({data:e={},onEnter:t,onBackspace:n}){this.data={url:e.url||""},this.onEnter=t,this.onBackspace=n,this.element=document.createElement("div"),this.element.className="youtube-block",this.element.setAttribute("data-block-type","youtube"),this.element.contentEditable=!1}render(){this.element.innerHTML="";const e=document.createElement("div");return e.style.cssText="\n            border: 1px solid #e2e8f0;\n            border-radius: 8px;\n            padding: 16px;\n            margin: 8px 0;\n            background: white;\n        ",this.data.url?this._renderVideo(e):this._renderUrlInput(e),this.element.appendChild(e),this.element}_renderUrlInput(e){const t=document.createElement("div");t.style.cssText="\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        ";const n=document.createElement("label");n.textContent="YouTube Video URL",n.style.cssText="\n            font-weight: 500;\n            color: #374151;\n            font-size: 14px;\n        ";const s=document.createElement("div");s.style.cssText="\n            display: flex;\n            gap: 8px;\n            align-items: center;\n        ";const i=document.createElement("input");i.type="url",i.placeholder="https://www.youtube.com/watch?v=...",i.value=this.data.url,i.style.cssText="\n            flex: 1;\n            padding: 8px 12px;\n            border: 1px solid #d1d5db;\n            border-radius: 6px;\n            font-size: 14px;\n            outline: none;\n            transition: border-color 0.2s;\n        ",i.addEventListener("focus",()=>{i.style.borderColor="#3b82f6"}),i.addEventListener("blur",()=>{i.style.borderColor="#d1d5db"});const o=document.createElement("button");o.textContent="Embed",o.style.cssText="\n            padding: 8px 16px;\n            background: #3b82f6;\n            color: white;\n            border: none;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 14px;\n            font-weight: 500;\n            transition: background-color 0.2s;\n        ",o.addEventListener("mouseover",()=>{o.style.background="#2563eb"}),o.addEventListener("mouseout",()=>{o.style.background="#3b82f6"}),o.addEventListener("click",()=>{const e=i.value.trim();this._isValidYouTubeUrl(e)?(this.data.url=e,this.render()):this._showError(i,"Please enter a valid YouTube URL")}),i.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),o.click())}),i.addEventListener("keydown",e=>{"Backspace"!==e.key||i.value||(e.preventDefault(),this.onBackspace?.())}),s.appendChild(i),s.appendChild(o),t.appendChild(n),t.appendChild(s);const a=document.createElement("p");a.textContent="Paste a YouTube video URL to embed it",a.style.cssText="\n            margin: 0;\n            font-size: 12px;\n            color: #6b7280;\n        ",t.appendChild(a),e.appendChild(t),setTimeout(()=>i.focus(),0)}_renderVideo(e){const t=document.createElement("div");t.style.cssText="\n            position: relative;\n            width: 100%;\n            max-width: 640px;\n            margin: 0 auto;\n        ";const n=document.createElement("iframe"),s=this._extractVideoId(this.data.url);n.src=`https://www.youtube.com/embed/${s}`,n.style.cssText="\n            width: 100%;\n            height: 360px;\n            border: none;\n            border-radius: 8px;\n            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);\n        ",n.setAttribute("frameborder","0"),n.setAttribute("allowfullscreen","true"),n.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture");const i=document.createElement("div");i.style.cssText="\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-top: 12px;\n            padding: 8px 0;\n        ";const o=document.createElement("div");o.textContent=this.data.url,o.style.cssText="\n            font-size: 12px;\n            color: #6b7280;\n            flex: 1;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n            margin-right: 12px;\n        ";const a=document.createElement("button");a.textContent="Edit",a.style.cssText="\n            padding: 4px 8px;\n            background: #f3f4f6;\n            border: 1px solid #d1d5db;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n            color: #374151;\n            transition: background-color 0.2s;\n        ",a.addEventListener("mouseover",()=>{a.style.background="#e5e7eb"}),a.addEventListener("mouseout",()=>{a.style.background="#f3f4f6"}),a.addEventListener("click",()=>{this.data.url="",this.render()});const r=document.createElement("button");r.textContent="Remove",r.style.cssText="\n            padding: 4px 8px;\n            background: #fef2f2;\n            border: 1px solid #fecaca;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n            color: #dc2626;\n            margin-left: 8px;\n            transition: background-color 0.2s;\n        ",r.addEventListener("mouseover",()=>{r.style.background="#fee2e2"}),r.addEventListener("mouseout",()=>{r.style.background="#fef2f2"}),r.addEventListener("click",()=>{this.onBackspace?.()}),t.appendChild(n),i.appendChild(o),i.appendChild(a),i.appendChild(r),e.appendChild(t),e.appendChild(i)}_isValidYouTubeUrl(e){return[/^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/,/^(https?:\/\/)?(www\.)?youtube\.com\/watch\?v=[\w-]+/,/^(https?:\/\/)?(www\.)?youtu\.be\/[\w-]+/].some(t=>t.test(e))}_extractVideoId(e){if(e.includes("youtu.be/"))return e.split("youtu.be/")[1].split("?")[0];if(e.includes("youtube.com/watch")){return new URLSearchParams(e.split("?")[1]).get("v")}return""}_showError(e,t){const n=document.createElement("div");n.textContent=t,n.style.cssText="\n            color: #dc2626;\n            font-size: 12px;\n            margin-top: 4px;\n        ",e.style.borderColor="#dc2626";e.parentElement.parentElement.appendChild(n),setTimeout(()=>{n.remove(),e.style.borderColor="#d1d5db"},3e3)}save(){return{type:"youtube",url:this.data.url}}}class o{static type="image";static name="Image";static icon='<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="#ffffff" stroke-width="2"/><circle cx="8.5" cy="8.5" r="1.5" fill="#ffffff"/><polyline points="21,15 16,10 5,21" stroke="#ffffff" stroke-width="2"/></svg>';static defaultData={src:"",alt:"",caption:"",width:"auto",height:"auto"};constructor({data:e={},onEnter:t,onBackspace:n,uploadFunction:s=null}){this.data={src:e.src||"",alt:e.alt||"",caption:e.caption||"",width:e.width||"auto",height:e.height||"auto"},this.onEnter=t,this.onBackspace=n,this.uploadFunction=s,this.element=document.createElement("div"),this.element.className="image-block",this.element.setAttribute("data-block-type","image"),this.element.contentEditable=!1}render(){this.element.innerHTML="";const e=document.createElement("div");return e.style.cssText="\n            border: 1px solid #e2e8f0;\n            border-radius: 8px;\n            padding: 16px;\n            margin: 8px 0;\n            background: white;\n        ",this.data.src?this._renderImage(e):this._renderUploadInterface(e),this.element.appendChild(e),this.element}_renderUploadInterface(e){const t=document.createElement("div");t.style.cssText="\n            display: flex;\n            flex-direction: column;\n            gap: 16px;\n            align-items: center;\n            padding: 20px;\n            border: 2px dashed #cbd5e1;\n            border-radius: 8px;\n            background: #f8fafc;\n        ";const n=document.createElement("div");n.innerHTML='\n            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">\n                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="#94a3b8"/>\n            </svg>\n        ',n.style.cssText="\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ";const s=document.createElement("div");s.style.cssText="\n            text-align: center;\n            color: #64748b;\n        ",s.innerHTML='\n            <div style="font-size: 16px; font-weight: 500; margin-bottom: 4px;">Upload an image</div>\n            <div style="font-size: 14px;">Click to browse or drag and drop</div>\n        ';const i=document.createElement("input");i.type="file",i.accept="image/*",i.style.cssText="\n            display: none;\n        ";const o=document.createElement("div");o.style.cssText="\n            display: flex;\n            gap: 8px;\n            align-items: center;\n        ";const a=document.createElement("button");a.textContent="Choose Image",a.style.cssText="\n            padding: 8px 16px;\n            background: #3b82f6;\n            color: white;\n            border: none;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 14px;\n            font-weight: 500;\n            transition: background-color 0.2s;\n        ",a.addEventListener("mouseover",()=>{a.style.background="#2563eb"}),a.addEventListener("mouseout",()=>{a.style.background="#3b82f6"});const r=document.createElement("button");r.textContent="Remove Block",r.style.cssText="\n            padding: 8px 16px;\n            background: #fef2f2;\n            color: #dc2626;\n            border: 1px solid #fecaca;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 14px;\n            font-weight: 500;\n            transition: background-color 0.2s;\n        ",r.addEventListener("mouseover",()=>{r.style.background="#fee2e2"}),r.addEventListener("mouseout",()=>{r.style.background="#fef2f2"}),r.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.onBackspace&&this.onBackspace()});const l=e=>{e&&e.type.startsWith("image/")?this._processImageFile(e):this._showError("Please select a valid image file.")};i.addEventListener("change",e=>{const t=e.target.files[0];l(t)}),a.addEventListener("click",()=>{i.click()}),t.addEventListener("dragover",e=>{e.preventDefault(),t.style.borderColor="#3b82f6",t.style.background="#eff6ff"}),t.addEventListener("dragleave",e=>{e.preventDefault(),t.style.borderColor="#cbd5e1",t.style.background="#f8fafc"}),t.addEventListener("drop",e=>{e.preventDefault(),t.style.borderColor="#cbd5e1",t.style.background="#f8fafc";const n=e.dataTransfer.files[0];l(n)}),t.addEventListener("keydown",e=>{"Backspace"===e.key&&(e.preventDefault(),this.onBackspace?.())}),t.appendChild(n),t.appendChild(s),o.appendChild(a),o.appendChild(r),t.appendChild(o),e.appendChild(t),e.appendChild(i)}_processImageFile(e){if(this._showLoading(),!this.uploadFunction)return this._hideLoading(),void this._showError("No upload function configured. Please set up image upload.");try{const t=this.uploadFunction(e);if(t&&"function"==typeof t.then)t.then(t=>{if(!t||"string"!=typeof t)throw new Error("Upload function must return a valid image URL");this.data.src=t,this.data.alt=e.name,this._hideLoading(),this.render()}).catch(e=>{this._hideLoading(),this._showError(e.message||"Upload failed")});else{const n=t;n&&"string"==typeof n?(this.data.src=n,this.data.alt=e.name,this._hideLoading(),this.render()):(this._hideLoading(),this._showError("Upload function must return a valid image URL"))}}catch(e){this._hideLoading(),this._showError(e.message||"Upload function error")}}_renderImage(e){const t=document.createElement("div");t.style.cssText="\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        ";const n=document.createElement("img");n.src=this.data.src,n.alt=this.data.alt,n.style.cssText="\n            max-width: 100%;\n            height: auto;\n            border-radius: 8px;\n            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);\n        ";const s=document.createElement("input");s.type="text",s.placeholder="Add a caption (optional)",s.value=this.data.caption,s.style.cssText="\n            padding: 8px 12px;\n            border: 1px solid #d1d5db;\n            border-radius: 6px;\n            font-size: 14px;\n            outline: none;\n            transition: border-color 0.2s;\n        ",s.addEventListener("focus",()=>{s.style.borderColor="#3b82f6"}),s.addEventListener("blur",()=>{s.style.borderColor="#d1d5db"}),s.addEventListener("input",()=>{this.data.caption=s.value});const i=document.createElement("div");i.style.cssText="\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 8px 0;\n        ";const o=document.createElement("input");o.type="text",o.placeholder="Alt text for accessibility",o.value=this.data.alt,o.style.cssText="\n            flex: 1;\n            padding: 4px 8px;\n            border: 1px solid #d1d5db;\n            border-radius: 4px;\n            font-size: 12px;\n            outline: none;\n            margin-right: 8px;\n        ",o.addEventListener("input",()=>{this.data.alt=o.value,n.alt=o.value});const a=document.createElement("button");a.textContent="Replace",a.style.cssText="\n            padding: 4px 8px;\n            background: #f3f4f6;\n            border: 1px solid #d1d5db;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n            color: #374151;\n            transition: background-color 0.2s;\n        ",a.addEventListener("mouseover",()=>{a.style.background="#e5e7eb"}),a.addEventListener("mouseout",()=>{a.style.background="#f3f4f6"}),a.addEventListener("click",()=>{this.data.src="",this.data.alt="",this.data.caption="",this.render()});const r=document.createElement("button");if(r.textContent="Remove",r.style.cssText="\n            padding: 4px 8px;\n            background: #fef2f2;\n            border: 1px solid #fecaca;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n            color: #dc2626;\n            margin-left: 8px;\n            transition: background-color 0.2s;\n        ",r.addEventListener("mouseover",()=>{r.style.background="#fee2e2"}),r.addEventListener("mouseout",()=>{r.style.background="#fef2f2"}),r.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.onBackspace&&this.onBackspace()}),t.appendChild(n),this.data.caption){const e=document.createElement("div");e.textContent=this.data.caption,e.style.cssText="\n                font-size: 14px;\n                color: #6b7280;\n                text-align: center;\n                font-style: italic;\n            ",t.appendChild(e)}t.appendChild(s),i.appendChild(o),i.appendChild(a),i.appendChild(r),e.appendChild(t),e.appendChild(i)}_showError(e){const t=document.createElement("div");t.textContent=e,t.style.cssText="\n            color: #dc2626;\n            font-size: 12px;\n            margin-top: 8px;\n            text-align: center;\n        ";this.element.querySelector("div").appendChild(t),setTimeout(()=>{t.remove()},3e3)}_showLoading(){this._hideLoading();const e=document.createElement("div");if(e.className="image-upload-loading",e.style.cssText="\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n            padding: 16px;\n            color: #64748b;\n            font-size: 14px;\n        ",e.innerHTML='\n            <div class="spinner" style="\n                width: 16px;\n                height: 16px;\n                border: 2px solid #e2e8f0;\n                border-top: 2px solid #3b82f6;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n            "></div>\n            <span>Uploading image...</span>\n        ',!document.querySelector("#image-upload-styles")){const e=document.createElement("style");e.id="image-upload-styles",e.textContent="\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n            ",document.head.appendChild(e)}this.element.querySelector("div").appendChild(e)}_hideLoading(){const e=this.element.querySelector(".image-upload-loading");e&&e.remove()}save(){return{type:"image",src:this.data.src,alt:this.data.alt,caption:this.data.caption,width:this.data.width,height:this.data.height}}}class a{static blocks={paragraph:{name:t.name,type:t.type,icon:t.icon,defaultData:t.defaultData},unorderedList:n.getUnorderedList(),orderedList:n.getOrderedList(),table:{name:s.name,type:s.type,icon:s.icon,defaultData:s.defaultData},youtube:{name:i.name,type:i.type,icon:i.icon,defaultData:i.defaultData},image:{name:o.name,type:o.type,icon:o.icon,defaultData:o.defaultData}};static getAllBlocks(){return Object.values(this.blocks)}static getBlock(e){return this.blocks[e]||null}static getBlockKeys(){return Object.keys(this.blocks)}static hasBlock(e){return e in this.blocks}static getBlockType(e){const t=this.getBlock(e);return t?t.type:null}}class r{constructor(e,a={}){this.holder="string"==typeof e?document.querySelector(e):e,this.isMenuOpen=!1,this.blocks=[],this.activeBlockIndex=-1,this.uploadFunction=a.uploadFunction||null,this.readOnly=a.readOnly||!1,this.styles=a.styles||{},this.title=a.title||null,this.required=a.required||!1,this.tools={paragraph:t,list:n,table:s,youtube:i,image:o},this.setupEditorStructure(),this.readOnly||this.renderToolbar()}setupEditorStructure(){this.holder.classList.add("bmark-editor"),this.holder.setAttribute("data-required",this.required.toString()),this.toolbarContainer=document.createElement("div"),this.toolbarContainer.className="bmark-toolbar-container",this.holder.appendChild(this.toolbarContainer),this.contentArea=document.createElement("div"),this.contentArea.className="bmark-content-area",this.holder.appendChild(this.contentArea)}addBlock(e,t={},n=null){if(this.readOnly)return null;const s=this.tools[e];if(!s)return console.warn(`Unknown block type: ${e}`),null;let i;const o={data:t,readOnly:this.readOnly,onEnter:()=>{const t=this.blocks.findIndex(e=>e.instance===i),n=i.getPendingSplitData?i.getPendingSplitData():null;this.addBlock(e,n||{},t)},onBackspace:()=>{const e=this.blocks.findIndex(e=>e.instance===i);if(-1!==e){const t=i.getPendingMergeData?i.getPendingMergeData():null;this.removeBlock(e,t)}}};"image"===e&&(o.uploadFunction=this.uploadFunction),i=new s(o);const a=i.render();a.setAttribute("data-block-type",e),a.classList.add("editor-block"),a.addEventListener("click",()=>{const e=this.blocks.findIndex(e=>e.instance===i);-1!==e&&this.setActiveBlock(e)}),a.addEventListener("focusin",()=>{const e=this.blocks.findIndex(e=>e.instance===i);-1!==e&&this.setActiveBlock(e)});const r=null!=n?n+1:this.blocks.length;return r>=this.blocks.length?this.contentArea.appendChild(a):this.contentArea.insertBefore(a,this.contentArea.children[r]),this.blocks.splice(r,0,{type:e,instance:i}),setTimeout(()=>{i.element?.focus(),this.setActiveBlock(r)},0),i}removeBlock(e,t=null){if(this.readOnly)return;if(this.blocks.length<=1){const{instance:t}=this.blocks[e],n=t.element;return n&&n.remove&&n.remove(),this.blocks.splice(e,1),void this.setActiveBlock(-1)}const{instance:n}=this.blocks[e],s=n.element;if(s&&s.remove&&s.remove(),t&&e>0){const n=this.blocks[e-1];if(n&&"paragraph"===n.type){const s=[...n.instance.data||[],...t.text||[]];n.instance.data=s,n.instance.element.innerHTML=n.instance._renderText(),n.instance.element.focus(),this.placeCaretAtEnd(n.instance.element),this.setActiveBlock(e-1)}else n?.instance?.element?.focus&&(n.instance.element.focus(),this.placeCaretAtEnd(n.instance.element),this.setActiveBlock(e-1))}else{this.activeBlockIndex>=e&&(this.activeBlockIndex=Math.max(0,this.activeBlockIndex-1));const t=this.blocks[e-1];if(t?.instance?.element?.focus)t.instance.element.focus(),this.placeCaretAtEnd(t.instance.element),this.setActiveBlock(e-1);else if(this.blocks.length>0){const e=this.blocks[0];e?.instance?.element?.focus&&(e.instance.element.focus(),this.setActiveBlock(0))}else this.setActiveBlock(-1)}this.blocks.splice(e,1)}placeCaretAtEnd(e){const t=document.createRange(),n=window.getSelection();t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t)}getBlocksData(){return this.blocks.map(({type:e,instance:t})=>t.save())}loadBlocks(e){this.blocks.forEach(({instance:e})=>{e.element&&e.element.remove&&e.element.remove()}),this.blocks=[],e.forEach(e=>{const{type:t,...n}=e;this.addBlock(t,n)}),this.blocks.length>0&&this.setActiveBlock(0)}renderToolbar(){const e=document.createElement("div");if(e.className="bmark-toolbar",e.style.cssText="\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            \n        ",this.title){const t=document.createElement("div");t.style.cssText="\n                flex: 1;\n                display: flex;\n                align-items: center;\n            ";const n=document.createElement("div");n.textContent=this.title,n.style.cssText="\n                font-size: 16px;\n                font-weight: 600;\n                color: #1e293b;\n            ",t.appendChild(n),e.appendChild(t)}const t=document.createElement("div");t.style.cssText="\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        ";const n=document.createElement("button");n.type="button",n.className="bmark-plus-button",n.innerHTML='\n            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">\n                <path d="M10 3v14M3 10h14" stroke="#334155" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n        ',n.title="Add Block",n.style.cssText="\n            padding: 6px;\n            background: #f8fafc;\n            border: 1px solid #e2e8f0;\n            border-radius: 6px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            transition: all 0.2s;\n        ";const s=document.createElement("button");s.type="button",s.className="bmark-remove-button",s.innerHTML='\n            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">\n                <path d="M6 6l8 8M14 6l-8 8" stroke="#dc2626" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n        ',s.title="Remove Active Block",s.style.cssText="\n            padding: 6px;\n            background: #fef2f2;\n            border: 1px solid #fecaca;\n            border-radius: 6px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            transition: all 0.2s;\n            opacity: 0.5;\n        ",s.addEventListener("click",()=>{-1!==this.activeBlockIndex&&this.blocks.length>0&&this.removeBlock(this.activeBlockIndex)});const i=document.createElement("div");i.className="bmark-dropdown-container";const o=document.createElement("div");o.style.cssText="\n            width: 0;\n            height: 0;\n            border-left: 8px solid transparent;\n            border-right: 8px solid transparent;\n            border-bottom: 8px solid #1e293b;\n            margin-left: 12px;\n            margin-bottom: -1px;\n        ";const r=document.createElement("div");r.className="bmark-dropdown-menu";a.getAllBlocks().forEach((e,t)=>{const n=document.createElement("div");n.className="bmark-menu-item",n.innerHTML=`\n                <div style="display: flex; align-items: center; justify-content: center; width: 20px; height: 20px;">\n                    ${e.icon}\n                </div>\n                <span>${e.name}</span>\n            `,n.addEventListener("click",()=>{this.addBlock(e.type,e.defaultData),this.toggleMenu()}),r.appendChild(n)}),n.addEventListener("click",e=>{e.preventDefault(),this.toggleMenu()}),document.addEventListener("click",t=>{e.contains(t.target)||this.closeMenu()}),i.appendChild(o),i.appendChild(r),t.appendChild(n),t.appendChild(s),t.appendChild(i),e.appendChild(t),this.toolbarContainer.appendChild(e),this.plusButton=n,this.removeButton=s,this.dropdownContainer=i,this.dropdownMenu=r}toggleMenu(){this.isMenuOpen?this.closeMenu():this.openMenu()}openMenu(){this.dropdownContainer.style.left="8px",this.dropdownContainer.style.top="100%",this.dropdownContainer.style.display="block",this.isMenuOpen=!0,this.plusButton.classList.add("active")}closeMenu(){this.dropdownContainer.style.display="none",this.isMenuOpen=!1,this.plusButton.classList.remove("active")}setReadOnly(e){this.readOnly=e,e?this.holder.classList.add("bmark-readonly"):this.holder.classList.remove("bmark-readonly"),this.blocks.forEach(t=>{t.instance&&t.instance.setReadOnly&&t.instance.setReadOnly(e)})}getHTML(){return this.contentArea.innerHTML}setActiveBlock(e){this.activeBlockIndex=e,this.updateRemoveButtonState()}updateRemoveButtonState(){this.removeButton&&(-1!==this.activeBlockIndex&&this.blocks.length>0?(this.removeButton.style.opacity="1",this.removeButton.style.cursor="pointer"):(this.removeButton.style.opacity="0.5",this.removeButton.style.cursor="not-allowed"))}updateToolbarTitle(e){this.title=e,this.toolbarContainer&&(this.toolbarContainer.innerHTML="",this.renderToolbar())}hasContent(){if(this.contentArea.textContent.trim().length>0)return!0;const e=this.contentArea.querySelectorAll("img"),t=this.contentArea.querySelectorAll("iframe");return e.length>0||t.length>0}validateEditor(){return!this.required||this.hasContent()}getValidationError(){return this.required?this.hasContent()?null:"Editor cannot be empty":null}setRequired(e){this.required=e,this.holder.setAttribute("data-required",e.toString())}destroy(){this.plusButton&&this.plusButton.removeEventListener("click",this.toggleMenu),this.blocks.forEach(e=>{e.instance&&e.instance.destroy&&e.instance.destroy()}),this.holder&&this.holder.innerHTML&&(this.holder.innerHTML=""),this.blocks=[],this.isMenuOpen=!1}}class l{constructor({model:e,view:t}){this.model=e,this.view=t,this.syncModelToView()}syncModelToView(){const e=this.view.getBlocksData();this.model.load(e)}save(){if(this.syncModelToView(),this.view.required&&!this.view.hasContent())throw new Error("Editor cannot be empty");return this.model.save()}load(e){this.model.load(e),this.view.loadBlocks(e)}validate(){return this.view.validateEditor()}getValidationError(){return this.view.getValidationError()}setRequired(e){this.view.setRequired(e)}}return class{constructor(t,n={}){this.elementId=t,this.controller=new l({model:new e,view:new r(this.elementId,{uploadFunction:n.uploadFunction,title:n.title,required:n.required})})}save(){return this.controller.save()}load(e){return this.controller.load(e)}setReadOnly(e){return this.controller.setReadOnly(e)}}}();
